YUI.add("gallery-exprbuilder",function(e,t){"use strict";function n(e){n.superclass.constructor.call(this,e)}function r(){this.ie_range=document.selection.createRange()}function i(t,n){n=n||t.length,this.field.focus();var r=e.Node.getDOMNode(this.field);if(r.setSelectionRange){var i=r.selectionStart;r.value=r.value.substring(0,i)+t+r.value.substring(r.selectionEnd,r.value.length);var s=i+n;r.setSelectionRange(s,s)}else if(document.selection){this.ie_range||(this.ie_range=document.selection.createRange());var o=this.ie_range.duplicate();o.text=t,this.ie_range.move("character",n),this.ie_range.select()}}function s(e){i.call(this,"()",1),e.halt()}function o(e){return function(t){i.call(this," "+this.get(e+"Label")+" "),t.halt()}}function u(e){this.clear(),e.halt()}function a(t){var n=this.get("queryBuilder");if(!n.validateFields()){t.halt();return}var r=n.toDatabaseQuery();if(r.length===0){var s=n.get("contentBox").one("select");n.displayFieldMessage(s,this.get("noVariableSelectedError"),"error"),t.halt();return}var o=this.get("combinatorMap"),u="",a=" "+this.get("andLabel")+" ";for(var f=0;f<r.length;f++){var l=r[f];f>0&&(u+=a),u+=l[0];var c=l[1];c.indexOf("{")==-1&&(c+="{value}");var h=o&&o[l[1]];h&&(a=h.operator,c=h.pattern),u+=e.Lang.substitute(c,{value:l[2].replace(/'/g,"\\'")})}i.call(this,u),n.reset(),t.halt()}function f(e){this.get("queryBuilder").reset(),e&&e.halt()}function l(e){if(!e)return;var t=this,n=e.validateForm;e.validateForm=function(){f.call(t),n.apply(this,arguments)},e.setFunction(this.get("fieldId"),function(e,n){return t._validateExpression(e,n,this)})}n.NAME="exprbuilder",n.ATTRS={fieldId:{value:e.guid(),validator:e.Lang.isString,writeOnce:!0},fieldName:{value:"",validator:e.Lang.isString,writeOnce:!0},formMgr:{validator:function(t){return!t||t instanceof e.FormManager},writeOnce:!0},queryBuilder:{validator:function(t){return!t||t instanceof e.QueryBuilder},writeOnce:!0},combinatorMap:{validator:e.Lang.isObject},parenLabel:{value:"()",validator:e.Lang.isString,writeOnce:!0},andLabel:{value:"AND",validator:e.Lang.isString,writeOnce:!0},orLabel:{value:"OR",validator:e.Lang.isString,writeOnce:!0},notLabel:{value:"NOT",validator:e.Lang.isString,writeOnce:!0},clearLabel:{value:"Clear",validator:e.Lang.isString,writeOnce:!0},insertLabel:{value:"Insert",validator:e.Lang.isString,writeOnce:!0},resetLabel:{value:"Cancel",validator:e.Lang.isString,writeOnce:!0},tooManyParensError:{value:'The expression contains an extra closing parenthesis at "{context}...".',validator:e.Lang.isString},unmatchedSingleQuoteError:{value:'The expression contains an unmatched single quote at "{context}...".',validator:e.Lang.isString},unclosedParenError:{value:'The expression contains an unclosed parenthesis at "{context}...".',validator:e.Lang.isString},noVariableSelectedError:{value:"Please choose a variable.",validator:e.Lang.isString}},e.extend(n,e.Widget,{initializer:function(e){l.call(this,e.formMgr),this.after("formMgrChange",function(e){e.prevVal&&e.prevVal.setFunction(this.get("fieldId"),null),l.call(this,e.newVal)})},renderUI:function(){var t=this.get("contentBox");t.set("innerHTML",this._field()),this.field=t.one("#"+this.get("fieldId")),document.selection&&this.field.on("change",r,this),t.one("."+this.getClassName("paren")).on("click",s,this);var n=["and","or","not"];for(var i=0;i<n.length;i++)t.one("."+this.getClassName(n[i])).on("click",o(n[i]),this);t.one("."+this.getClassName("clear")).on("click",u,this);var l=this.get("queryBuilder");l&&(t.appendChild(e.Node.create(this._query())),l.render(t.one("."+this.getClassName("querybuilder"))),t.one("."+this.getClassName("insert")).on("click",a,this),t.one("."+this.getClassName("reset")).on("click",f,this))},destructor:function(){var e=this.get("queryBuilder");e&&e.destroy(),this.ie_range=null},clear:function(){this.field.set("value",""),this.field.focus()},_validateExpression:function(t,n,r){var i=n.get("value"),s=0,o=-1,u=!1,a=-1;for(var f=0;f<i.length;f++){var l=i.charAt(f);if(!u&&l=="(")s===0&&(o=f),s++;else if(!u&&l==")"){s--;if(s<0){var c=e.Lang.substitute(this.get("tooManyParensError"),{context:i.substr(0,f+1)});return r.displayMessage(n,c,"error"),!1}}else l=="'"&&(f===0||i.charAt(f-1)!="\\")&&(u||(a=f),u=!u)}if(u&&(s===0||a<o)){var c=e.Lang.substitute(this.get("unmatchedSingleQuoteError"),{context:i.substr(0,a+1)});return r.displayMessage(n,c,"error"),!1}if(s>0){var c=e.Lang.substitute(this.get("unclosedParenError"),{context:i.substr(0,o+1)});return r.displayMessage(n,c,"error"),!1}return!0},_field:function(){var t='<div class="{td}"><textarea id="{tid}" name="{tn}" class="{ff} {ta}"></textarea></div><div class="{fctl}"><button type="button" class="yui3-button {pc}">{paren}</button><button type="button" class="yui3-button {ac}">{and}</button><button type="button" class="yui3-button {oc}">{or}</button><button type="button" class="yui3-button {nc}">{not}</button><button type="button" class="yui3-button {cc}">{clear}</button></div>';return e.Lang.substitute(t,{td:this.getClassName("field-container"),ff:e.FormManager.field_marker_class,ta:this.getClassName("field"),tid:this.get("fieldId"),tn:this.get("fieldName"),fctl:this.getClassName("controls"),pc:this.getClassName("paren"),ac:this.getClassName("and"),oc:this.getClassName("or"),nc:this.getClassName("not"),cc:this.getClassName("clear"),paren:this.get("parenLabel"),and:this.get("andLabel"),or:this.get("orLabel"),not:this.get("notLabel"),clear:this.get("clearLabel")})},_query:function(){var t='<div class="{qb}"></div><div class="{qbctl} {fr}"><button type="button" class="yui3-button {ic}">{insert}</button><button type="button" class="yui3-button {rc}">{reset}</button></div>';return e.Lang.substitute(t,{qb:this.getClassName("querybuilder"),qbctl:this.getClassName("querybuilder-controls"),fr:e.FormManager.row_marker_class,ic:this.getClassName("insert"),rc:this.getClassName("reset"),insert:this.get("insertLabel"),reset:this.get("resetLabel")})}}),e.ExpressionBuilder=n},"gallery-2013.01.16-21-05",{skinnable
:"true",requires:["gallery-querybuilder","gallery-formmgr"]});
