YUI.add("gallery-treeble",function(Y,NAME){"use strict";function TreebleDataSource(){TreebleDataSource.superclass.constructor.apply(this,arguments)}function populateOpen(e,t,n){var r=n.data,i=n.start,s=n.ds.treeble_config.childNodesKey,o=n.ds.treeble_config.nodeOpenKey;for(var u=0;u<t.length;u++)if(t[u].index>=i)break;var a=this.get("uniqueIdKey"),f=!0;for(var l=0;l<r.length;l++){var c=i+l,h=r[l][s];if(!h)continue;while(u<t.length&&t[u].index<c)t.splice(u,1),f=!1,a&&delete this._open_cache[r[l][a]];if(u>=t.length||t[u].index>c){var p={index:c,open:null,ds:h,children:[],childTotal:0,parent:e},d=null;a&&(d=this._open_cache[r[l][a]],d&&(p.open=d.open,p.childTotal=d.childTotal,this._redo=this._redo||p.open),this._open_cache[r[l][a]]=p),!d&&o&&r[l][o]&&this._toggle.push(n.path.concat(c)),t.splice(u,0,p)}u++}return f}function searchOpen(e,t){for(var n=0;n<e.length;n++)if(e[n].index==t)return e[n];return!1}function getNode(e){var t=this._open,n=e.length-1;for(var r=0;r<n;r++){var i=searchOpen(t,e[r]);t=i.children}return searchOpen(t,e[n])}function countVisibleNodes(e){var t=0;e||(e=this._open,t=this._topNodeTotal);if(this.get("paginateChildren"))for(var n=0;n<e.length;n++){var r=e[n];r.open&&(t+=r.childTotal,t+=countVisibleNodes.call(this,r.children))}return t}function requestTree(e){if(!e)var t=this._toggle.slice(0);this._cancelAllRequests(),e||(this._toggle=t),this._redo=!1,this._generating_requests=!0;var n=this._callback.request;this.get("paginateChildren")?this._slices=getVisibleSlicesPgAll(n.startIndex,n.resultCount,this.get("root"),this._open):this._slices=getVisibleSlicesPgTop(n.startIndex,n.resultCount,this.get("root"),this._open),requestSlices.call(this,n),this._generating_requests=!1,checkFinished.call(this)}function getVisibleSlicesPgTop(e,t,n,r,i){r=r.concat({index:-1,open:!0,childTotal:0,children:null}),i||(i=[]);var s=[],o=!1,u=0,a=-1,f=!1;for(var l=0;l<r.length;l++){var c=r[l];if(!c.open)continue;var h=c.index-a;if(u+h>=e+t||c.index==-1)return s.push({ds:n,path:i.slice(0),start:o?u:e,end:e+t-1}),u+h==e+t&&c.childTotal>0&&(s=s.concat(getVisibleSlicesPgTop(0,c.childTotal,c.ds,c.children,i.concat(c.index)))),s;!o&&u+h==e?f=!0:u+h>e&&(s.push({ds:n,path:i.slice(0),start:o?a+1:e,end:u+h-1}),o=!0),u+=h,o&&c.childTotal>0&&(s=s.concat(getVisibleSlicesPgTop(0,c.childTotal,c.ds,c.children,i.concat(c.index)))),a=c.index,o=o||f}}function getVisibleSlicesPgAll(e,t,n,r,i,s,o,u,a){s||(i=[],s=null,o=0,u=!1,a=[]);var f=s?s.ds:n;r=r.concat({index:s?s.childTotal:-1,open:!0,childTotal:0,children:null});var l=0,c=0,h=-1;for(var p=0;p<r.length;p++){var d=r[p];if(!d.open)continue;var v=d.index-h;d.children===null&&v--;if(o+l+v>=e+t||d.index==-1)return a.push({ds:f,path:i.slice(0),start:c+(u?0:e-o-l),end:c+(e+t-1-o-l)}),a;!u&&o+l+v==e?u=!0:o+l+v>e&&(a.push({ds:f,path:i.slice(0),start:c+(u?0:e-o-l),end:c+v-1}),u=!0),l+=v,c+=v;if(d.childTotal>0){var m=getVisibleSlicesPgAll(e,t,n,d.children,i.concat(d.index),d,o+l,u,a);if(Y.Lang.isArray(m))return m;l+=m.count,u=m.send}h=d.index}var m={count:l,send:u};return m}function requestSlices(e){for(var t=0;t<this._slices.length;t++){var n=this._slices[t],r=n.ds,i=findRequest.call(this,r);if(i){if(Y.Console){i.end+1<n.start&&Y.error("TreebleDataSource found discontinuous range");if(i.path.length!=n.path.length)Y.error("TreebleDataSource found path length mismatch");else for(var s=0;s<n.path.length;s++)if(i.path[s]!=n.path[s]){Y.error("TreebleDataSource found path mismatch");break}}i.end=n.end}else this._req.push({ds:r,path:n.path,start:n.start,end:n.end})}e=Y.clone(e,!0);for(var t=0;t<this._req.length;t++){var i=this._req[t];e.startIndex=i.start,e.resultCount=i.end-i.start+1,i.txId=i.ds.sendRequest({request:i.ds.treeble_config.generateRequest(e,i.path),cfg:i.ds.treeble_config.requestCfg,callback:{success:Y.rbind(treeSuccess,this,t),failure:Y.rbind(treeFailure,this,t)}})}}function findRequest(e){for(var t=0;t<this._req.length;t++){var n=this._req[t];if(e==n.ds)return n}return null}function treeSuccess(e,reqIndex){if(!e.response||e.error||!Y.Lang.isArray(e.response.results)){treeFailure.apply(this,arguments);return}var req=searchTxId(this._req,e.tId,reqIndex);if(!req)return;!this._topResponse&&req.ds==this.get("root")&&(this._topResponse=e.response),req.txId=null,req.resp=e.response,req.error=!1;var dataStartIndex=0;req.ds.treeble_config.startIndexExpr&&eval("dataStartIndex=req.resp"+req.ds.treeble_config.startIndexExpr);var sliceStartIndex=req.start-dataStartIndex;req.data=e.response.results.slice(sliceStartIndex,req.end-dataStartIndex+1),setNodeInfo(req.data,req.start,req.path,req.ds);var parent=req.path.length>0?getNode.call(this,req.path):null,open=parent!==null?parent.children:this._open;if(!populateOpen.call(this,parent,open,req)){treeFailure.apply(this,arguments);return}!parent&&req.ds.treeble_config.totalRecordsExpr?eval("this._topNodeTotal=e.response"+req.ds.treeble_config.totalRecordsExpr):!parent&&req.ds.treeble_config.totalRecordsReturnExpr&&(this._topNodeTotal=e.response.results.length),checkFinished.call(this)}function treeFailure(e,t){var n=searchTxId(this._req,e.tId,t);if(!n)return;this._cancelAllRequests(),this._callback.error=e.error,this._callback.response=e.response,this.fire("response",this._callback)}function setNodeInfo(e,t,n,r){var i=n.length;for(var s=0;s<e.length;s++)e[s]._yui_node_depth=i,e[s]._yui_node_path=n.concat(t+s),e[s]._yui_node_ds=r}function searchTxId(e,t,n){for(var r=0;r<e.length;r++)if(e[r].txId===t)return e[r];return n<e.length&&Y.Lang.isUndefined(e[n].txId)?e[n]:null}function checkFinished(){if(this._generating_requests)return;var count=this._req.length;for(var i=0;i<count;i++)if(!this._req[i].resp)return;if(this._redo){Y.Lang.later(0,this,requestTree);return}if(this._toggle.length>0){var t=this._toggle.shift();this.toggle(t,Y.clone(this._callback.request,!0),{fn:function(){Y.Lang.later(0,this,requestTree)},scope:this});return}var response={meta:{}};Y.mix(response,this._topResponse,!0),response.results=[],response=Y.clone(response
,!0),count=this._slices.length;for(i=0;i<count;i++){var slice=this._slices[i],req=findRequest.call(this,slice.ds);if(!req){Y.error("Failed to find request for a slice");continue}var j=slice.start-req.start,data=req.data.slice(j,j+slice.end-slice.start+1);response.results=response.results.concat(data)}var rootDS=this.get("root");rootDS.treeble_config.totalRecordsExpr?eval("response"+rootDS.treeble_config.totalRecordsExpr+"="+countVisibleNodes.call(this)):rootDS.treeble_config.totalRecordsReturnExpr&&eval("response"+rootDS.treeble_config.totalRecordsReturnExpr+"="+countVisibleNodes.call(this)),this._callback.response=response,this.fire("response",this._callback)}function toggleSuccess(e,node,completion,path){node.ds.treeble_config.totalRecordsExpr?eval("node.childTotal=e.response"+node.ds.treeble_config.totalRecordsExpr):node.ds.treeble_config.totalRecordsReturnExpr&&(node.childTotal=e.response.results.length),node.open=!0,node.children=[],complete(completion),this.fire("toggled",{path:path,open:node.open})}function toggleFailure(e,t,n,r){t.childTotal=0,t.open=!0,t.children=[],complete(n),this.fire("toggled",{path:r,open:t.open})}function complete(e){Y.Lang.isFunction(e)?e():e&&e.fn&&e.fn.apply(e.scope||window,Y.Lang.isUndefined(e.args)?[]:e.args)}function compareRequests(e,t){var n=Y.Object.keys(e),r=Y.Object.keys(t);if(n.length!=r.length)return!1;for(var i=0;i<n.length;i++){var s=n[i];if(s!="startIndex"&&s!="resultCount"&&e[s]!==t[s])return!1}return!0}function Treeble(){Treeble.superclass.constructor.apply(this,arguments)}TreebleDataSource.NAME="treebleDataSource",TreebleDataSource.ATTRS={root:{writeOnce:!0},paginateChildren:{value:!1,validator:Y.Lang.isBoolean,writeOnce:!0},uniqueIdKey:{validator:Y.Lang.isString}},Y.extend(TreebleDataSource,Y.DataSource.Local,{initializer:function(e){e.root||Y.error("TreebleDataSource requires DataSource");if(!e.root.treeble_config.childNodesKey){var t=e.root.schema.get("schema").resultFields;(!t||!Y.Lang.isArray(t))&&Y.error("TreebleDataSource root DataSource requires schema.resultFields because treeble_config.childNodesKey was not specified.");for(var n=0;n<t.length;n++)if(Y.Lang.isObject(t[n])&&t[n].parser=="treebledatasource"){e.root.treeble_config.childNodesKey=t[n].key;break}e.root.treeble_config.childNodesKey||Y.error("TreebleDataSource requires treeble_config.childNodesKey configuration to be set on root DataSource")}e.root.treeble_config.generateRequest||Y.error("TreebleDataSource requires treeble_config.generateRequest configuration to be set on root DataSource"),!e.root.treeble_config.totalRecordsExpr&&!e.root.treeble_config.totalRecordsReturnExpr&&Y.error("TreebleDataSource requires either treeble_config.totalRecordsExpr or treeble_config.totalRecordsReturnExpr configuration to be set on root DataSource"),this._open=[],this._open_cache={},this._toggle=[],this._req=[]},isOpen:function(e){var t=this._open;for(var n=0;n<e.length;n++){var r=searchOpen.call(this,t,e[n]);if(!r||!r.open)return!1;t=r.children}return!0},toggle:function(e,t,n){var r=this._open;for(var i=0;i<e.length;i++){var s=searchOpen.call(this,r,e[i]);if(!s)return!1;r=s.children}return s.open===null?(t.startIndex=0,t.resultCount=0,s.ds.sendRequest({request:s.ds.treeble_config.generateRequest(t,e),cfg:s.ds.treeble_config.requestCfg,callback:{success:Y.rbind(toggleSuccess,this,s,n,e),failure:Y.rbind(toggleFailure,this,s,n,e)}})):(s.open=!s.open,complete(n),this.fire("toggled",{path:e,open:s.open})),!0},_defRequestFn:function(e){this._callback&&!compareRequests(this._callback.request,e.request)&&(this._open=[]),this._callback=e,requestTree.call(this,!0)},_cancelAllRequests:function(){this._req=[],this._toggle=[],delete this._topResponse}}),Y.TreebleDataSource=TreebleDataSource,Y.namespace("DataSource").Treeble=TreebleDataSource,Y.namespace("Parsers").treebledatasource=function(e){if(!e)return null;var t=e.dataType;t||(Y.Lang.isString(e)?t="IO":Y.Lang.isFunction(e)?t="Function":t="Local");var n=e.dataType?e.liveData:e,r=this.get("host").treeble_config;t=="Local"?(r=Y.clone(r,!0),delete r.startIndexExpr,delete r.totalRecordsExpr):t=="Function"&&(n=Y.Lang.isString(n)?window[n]:n);var i=new Y.DataSource[t]({source:n});return i.treeble_config=r,i.treeble_config.schemaPluginConfig&&i.plug(Y.clone(i.treeble_config.schemaPluginConfig,!0)),i.treeble_config.cachePluginConfig&&i.plug(Y.clone(i.treeble_config.cachePluginConfig,!0)),i},Treeble.NAME="datatable",Treeble.buildTwistdownFormatter=function(e){return function(t){t.td.addClass("treeble-nub");var n=this.datasource.get("datasource"),r=n.get("root").treeble_config.childNodesKey;if(t.data[r]){var i=t.data._yui_node_path;t.td.addClass("row-toggle"),t.td.replaceClass("row-(open|closed)",n.isOpen(i)?"row-open":"row-closed"),YUI.Env.add(Y.Node.getDOMNode(t.td),"click",function(){n.toggle(i,{},e)}),t.cell.set("innerHTML",'<a class="treeble-expand-nub" href="javascript:void(0);"></a>')}return!1}},Treeble.treeValueFormatter=function(e){var t="treeble-depth-"+e.data._yui_node_depth;return e.rowClass+=" "+t,e.className+=" treeble-value",'<span class="'+t+'">'+e.value+"</span>"},Y.extend(Treeble,Y.DataTable,{plug:function(e,t){if(e===Y.Plugin.DataTableDataSource){var n=this.get("recordType");n.ATTRS[t.datasource.get("root").treeble_config.childNodesKey]={},n.ATTRS._yui_node_path={},n.ATTRS._yui_node_depth={}}Treeble.superclass.plug.apply(this,arguments)}}),Y.Treeble=Treeble},"gallery-2013.04.03-19-53",{skinnable:"true",requires:["datasource","datatable"]});
