YUI.add("gallery-itsamodellistsyncpromise",function(e,t){"use strict";var n=e.ModelList,r=e.Lang,i=e.Array,s=e.Object,o="_pub_",u="read",a="append",f="delete",l=u+a,c="modelsync",h="gallery-itsa",p="promise",d=h+c+p,v="_removableby"+p,m={load:!0,reload:!0,save:!0,submit:!0,destroy:!0},g="_defFn_",y="error",b="save",w="submit",E="load",S="reload",x=E+a,T="destroy",N=T+"models",C="Promise",k=function(t){if(typeof t=="string")try{return e.JSON.fullparse(t)}catch(n){return this.fire(y,{error:n,response:t,src:"parse"}),{}}return t||{}};n.prototype.addMessageTarget=function(t){var n=this;e.usePromise(h+"messagecontroller",h+"messageviewer",h+"panel",h+"viewmodel").then(function(){return e.ITSAMessageController.isReady()}).then(function(){t instanceof e.ITSAPanel&&(t=t._itsastatusbar),t||t instanceof e.ITSAViewModel&&(t=t._itsastatusbar),t instanceof e.ITSAMessageViewer&&(n._itsamessageListener&&n.removeMessageTarget(),n._itsamessageListener=n.on([E,w,b,T],function(r){var i=r.options,s=i.remove||i[f],o=r.type,u=o.split(":"),a=u[1]||u[0],l,h;if(a!==T||s)h=n._defSyncMessages,l=t.showStatus(r.syncmessage||h&&h[a]||e.Intl.get(d)[a],{source:c,busy:!0}),r.promise.then(function(){t.removeStatus(l)},function(){t.removeStatus(l)})}),n._itsamessagedestroylistener1=n.onceAfter(T,function(){n._itsamessageListener.detach()}),n._itsamessagedestroylistener2=t.once(T,function(){n._itsamessageListener.detach()}))})},n.prototype.defSyncOptions=function(){return new e.Promise(function(e){e({})})},i.each([E,x,S,b,w,N],function(e){n.prototype[e]=function(t,n){var r=this,i;return(i=r[e+C](t))&&n&&i.then(function(e){n(null,e)},function(e){n(e)}),r},n.prototype[e+C]=function(t){return this._createPromise(e,t)}}),n.prototype.removeMessageTarget=function(){var e=this;e._itsamessageListener&&e._itsamessageListener.detach(),e._itsamessagedestroylistener1&&e._itsamessagedestroylistener1.detach(),e._itsamessagedestroylistener2&&e._itsamessagedestroylistener2.detach(),e._itsamessageListener=null},n.prototype.setSyncMessage=function(e,t){var n=this;return n._defSyncMessages||(n._defSyncMessages={}),m[e]&&(n._defSyncMessages[e]=t),n},n.prototype._createPromise=function(t,n){var i=this,u,a,f,l;return u=new e.Promise(function(e,t){a=e,f=t}),l={promise:u,promiseResolve:a,promiseReject:f,response:"",parsed:{},options:e.merge(n)},r.isObject(n)&&s.each(n,function(e,t){l[t]=e}),i[o+t]||(i[o+t]=i._publishAsync(t,{defaultTargetOnly:!0,emitFacade:!0,broadcast:1,defaultFn:i[g+t],preventedFn:i._prevDefFn})),i.fire(t,l),u},n.prototype[g+N]=function(t){var n=this,r=[],i=t.options;return n.each(function(e){r.push(e.destroyPromise(i))}),e.batch.apply(e,r).then(function(e){t.promiseResolve(e)},function(e){t.promiseReject(new Error(e))}),t.promise},i.each([E,x,S],function(e){n.prototype[g+e]=function(t){var n=this,r=t.options||{},s=e===x||r.append?l:u,o,a;return o=function(i){var s={options:r,error:i,src:e};n._lazyFireErrorEvent(s),t.promiseReject(new Error(i))},a=function(s){var o,u;t.response=s,o=k(s),o.responseText&&o.responseText&&(o=k(o.responseText)),t.parsed=o,e===x||r.append?n.add(o,r):e===E?n.reset(o,r):(n.each(function(e){e[v]=!0}),u=n.model&&n.model.prototype.idAttribute||"id",i.each(o,function(e){var t=e[u],i,s;i=s=t&&n.getById(t),s?(n.revive&&(s=n.revive(s)),s.setAttrs(e,r),delete i[v]):n.add(e,r)}),n.each(function(e){e[v]&&n.remove(e)})),t.promiseResolve(s)},n.syncPromise?n._syncTimeoutPromise(s,r).then(a,o):n.sync(s,r,function(e,t){e?o(e):a(t)}),t.promise}}),n.prototype[g+b]=function(t){var n=this,r=[],i=t.options;return n.each(function(e){e.isModified()&&r.push(e.savePromise(i))}),e.batch.apply(e,r).then(function(e){t.promiseResolve(e)},function(e){t.promiseReject(new Error(e))}),t.promise},n.prototype[g+w]=function(t){var n=this,r=[],i=t.options;return n.each(function(e){e.submitPromise&&r.push(e.submitPromise(i))}),e.batch.apply(e,r).then(function(e){t.promiseResolve(e)},function(e){t.promiseReject(new Error(e))}),t.promise},n.prototype._lazyFireErrorEvent=function(e){var t=this;t._errorEvent||(t._errorEvent=t.publish(y,{broadcast:1})),t.fire(y,e)},n.prototype._publishAsync=function(t,n){var r=this,i=r.publish(t,n);return n&&n.broadcast===1&&r.addTarget(e),n&&n.broadcast===2&&r.addTarget(YUI),i._firing=new e.Promise(function(e){e()}),i.fire=function(t){var n=e.Array(arguments,0,!0),s,o;i._firing=i._firing.then(function(){s={id:i.id,next:i,silent:i.silent,stopped:0,prevented:0,bubbling:null,type:i.type,defaultTargetOnly:i.defaultTargetOnly},i.details=n;var e=i._subscribers,u=[],a,f,l;u.push.apply(u,t),a=i._createFacade(u),a.target=a.target||r;if(e)for(f=0,l=e.length;f<l;++f)try{e[f].fn.call(e[f].context,a)}catch(c){}return i.bubbles&&!i.stopped&&(r.bubble(i,n,null,s),a.prevented=Math.max(a.prevented,s.prevented)),a.prevented?i.preventedFn.call(r,a).then(null,function(e){return!1}):i.defaultFn.call(r,a).then(function(){e=i._afters;if(e)for(f=0,l=e.length;f<l;++f)try{e[f].fn.call(e[f].context,a)}catch(t){}if(s.afterQueue)while(o=s.afterQueue.last())o()}).then(null,function(e){return!1})},function(e){var t={error:e&&(e.message||e),src:"ModelList._publishAsync()"};r._lazyFireErrorEvent(t)})},i._fire=function(e){return i.fire(e[0])},i},n.prototype._prevDefFn=function(e){e.promiseReject(new Error("preventDefaulted"))},n.prototype._syncTimeoutPromise=function(t,n){var r=this;return r.defSyncOptions().then(function(i){var s=r.syncPromise(t,e.merge(i,n));return s instanceof e.Promise?s:new e.Promise(function(e,n){var r="syncPromise is rejected --> "+t+" not defined as a Promise inside syncPromise()";n(new Error(r))})})},n.prototype.destroyPromise=n.prototype.destroyModelPromise},"gallery-2014.01.28-00-45",{requires:["yui-base","base-base","base-build","node-base","json-parse","promise","model","model-list","gallery-itsamodelsyncpromise","gallery-itsamodulesloadedpromise","gallery-itsautils"]});
