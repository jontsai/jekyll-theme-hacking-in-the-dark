YUI.add("gallery-datatable-editable",function(e,t){DtEditable=function(){},DtEditable.ATTRS={editable:{value:!1,validator:e.Lang.isBoolean},editOpenType:{value:"dblclick",validator:function(t){return e.Lang.isString(t)||t===null}},defaultEditor:{value:null,validator:function(t){return e.Lang.isString(t)||t===null}}},e.mix(DtEditable.prototype,{_openEditor:null,_openRecord:null,_openColKey:null,_openTd:null,_openCell:null,_subscrEditable:null,_subscrEditOpen:null,_subscrCellEditors:null,_subscrCellEditorScrolls:null,_classColEditable:null,_commonEditors:null,_columnEditors:null,initializer:function(){return this._classColEditable=this.getClassName("col","editable"),this.get("editable")&&this._onEditableChange(!0),this.after("editableChange",this._onEditableChange),this._bindEditable(),this},destructor:function(){this.set("editable",!1),this._unbindEditable()},openCellEditor:function(t){var n=t.currentTarget||t,r=this.getColumnByTd(n),i=r.key||r.name,s=i?this._columnEditors[i]:null,o=s&&e.Lang.isString(s)?this._commonEditors[s]:s;if(!n)return;(this._yScroll||this._xScroll)&&!this._subscrCellEditorScroll&&this._bindEditorScroll();if(r&&r.editable===!1&&!o)return;this._openEditor&&(this._openEditor===o?this._openEditor.hideEditor():this.hideCellEditor()),o&&(this._openTd=n,this._openEditor=o,this._openRecord=this.getRecord(n),this._openColKey=i,this._openCell={td:n,value:this._openRecord.get(i),recClientId:this._openRecord.get("clientId"),colKey:i},this._openEditor.setAttrs({cell:this._openCell,value:this._openRecord.get(i)}),this._openEditor.showEditor(n))},hideCellEditor:function(){this._openEditor&&(this._openEditor.hideEditor(),this._unsetEditor())},hideAllCellEditors:function(){this.hideCellEditor();var t=this._getAllCellEditors();e.Array.each(t,function(e){e&&e.hideEditor&&e.hideEditor()})},bindEditorListeners:function(){return},getCellEditors:function(){var t=[],n;return e.Object.each(this._columnEditors,function(r,i){n=e.Lang.isString(r)?this._commonEditors[r]:r,t.push({columnKey:i,cellEditor:n,cellEditorName:n.get("name")})},this),t},getCellEditor:function(t){var n=this._columnEditors,r=t&&typeof t!="object"?this.getColumn(t):null,i=r?r.key||r.name:null,s=null;return i&&n[i]&&(e.Lang.isString(n[i])?s=this._commonEditors[n[i]]:s=n[i]),s},getColumnByTd:function(e){var t=this.getColumnNameByTd(e);return t?this.getColumn(t):null},getColumnNameByTd:function(t){var n=t.get("className").split(" "),r=new RegExp(this.getClassName("col")+"-(.*)"),i;return e.Array.some(n,function(t){var n=t.match(r);if(n&&e.Lang.isArray(n)&&n[1])return i=n[1],!0}),i||null},_bindEditable:function(){var t=this.get("editOpenType");this._subscrEditable&&e.Array.each(this._subscrEditable,function(e){e&&e.detach&&e.detach()}),this._subscrEditable=[],t=t&&e.Lang.isString(t)&&t.search(/none/i)===-1?t:null,t&&(this._subscrEditOpen&&this._subscrEditOpen.detach(),this._subscrEditOpen=this.delegate(t,this.openCellEditor,"tbody."+this.getClassName("data")+" td",this)),this._subscrEditable.push(e.Do.after(this._updateAllEditableColumnsCSS,this,"syncUI"),this.after("sort",this._afterEditableSort),this.after("editOpenTypeChange",this._onEditOpenTypeChange),this.after("defaultEditorChange",this._onDefaultEditorChange))},_unbindEditable:function(){this._subscrEditable&&e.Array.each(this._subscrEditable,function(e){e&&e.detach&&e.detach()}),this._subscrEditable=null,this._subscrEditOpen&&this._subscrEditOpen.detach(),this._subscrEditOpen=null,this._openEditor&&this._openEditor.destroy&&this._openEditor.destroy(),this._subscrCellEditorScrolls&&e.Lang.isArray(this._subscrCellEditorScrolls)&&(e.Array.each(this._subscrCellEditorScroll,function(e){e&&e.detach&&e.detach()}),this._subscrCellEditorScrolls=[]),this.detach("celleditor:*"),this._unsetEditor(),this._destroyColumnEditors()},_bindCellEditingListeners:function(){this._subscrCellEditors&&this._unbindCellEditingListeners(),this._subscrCellEditors=[],this._subscrCellEditors.push(e.one("body").after("keydown",e.bind(this._onKeyEsc,this)),this.on("celleditor:editorSave",this._onCellEditorSave),this.on("celleditor:editorCancel",this._onCellEditorCancel),this.on("celleditor:keyDirChange",this._onKeyDirChange))},_unbindCellEditingListeners:function(){this._subscrCellEditors&&(e.Array.each(this._subscrCellEditors,function(e){e&&e.detach&&e.detach()}),this._subscrCellEditors=null)},_bindEditorScroll:function(){this._subscrCellEditorScrolls=[],this._xScroll&&this._xScrollNode&&this._subscrCellEditorScrolls.push(this._xScrollNode.on("scroll",this._onScrollUpdateCellEditor,this)),this._yScroll&&this._yScrollNode&&this._subscrCellEditorScrolls.push(this._yScrollNode.on("scroll",this._onScrollUpdateCellEditor,this))},_onEditableChange:function(e){e.newVal||e===!0?(this._bindEditable(),this.bindEditorListeners(),this._bindCellEditingListeners(),this._buildColumnEditors()):(this._unbindEditable(),this._unbindCellEditingListeners(),this._destroyColumnEditors())},_onDefaultEditorChange:function(e){var t=e.newVal;t&&t.search(/none/i)===-1&&this.get("editable")&&(this.set("editable",!1),this.set("editable",!0))},_onEditOpenTypeChange:function(){this.get("editable")&&(this.set("editable",!1),this.set("editable",!0))},_buildColumnEditors:function(){var t=this.get("columns"),n=this.get("defaultEditor"),r,i,s;if(!e.DataTable.EditorOptions)return;(this._columnEditors||this._commonEditors)&&this._destroyColumnEditors(),this._commonEditors={},this._columnEditors={},n=n&&n.search(/none|null/i)!==0?n:null,e.Array.each(t,function(t){if(!t)return;i=t.key||t.name,i&&t.editable!==!1&&(r=t.editor||n,this._updateEditableColumnCSS(i,!0),r&&e.DataTable.EditorOptions[r]&&(t.editorConfig&&e.Lang.isObject(t.editorConfig)?(s=this._createCellEditorInstance(r,t),this._columnEditors[i]=s||null):(this._commonEditors[r]||(s=this._createCellEditorInstance(r,t),this._commonEditors[r]=s),this._columnEditors[i]=r)))},this)},_createCellEditorInstance:function(t,n){var r=e.clone(e.DataTable.EditorOptions[t],!0),i=e.DataTable.EditorOptions
[t].BaseViewClass,s;return n.editorConfig&&e.Lang.isObject(n.editorConfig)&&(r=e.merge(r,n.editorConfig),n.editorConfig.overlayConfig&&(r.overlayConfig=e.merge(r.overlayConfig||{},n.editorConfig.overlayConfig)),n.editorConfig.widgetConfig&&(r.widgetConfig=e.merge(r.widgetConfig||{},n.editorConfig.widgetConfig)),n.editorConfig.templateObject&&(r.templateObject=e.merge(r.templateObject||{},n.editorConfig.templateObject)),r.name=t),delete r.BaseViewClass,i&&(r.hostDT=this,s=new i(r),s.addTarget(this)),s},_destroyColumnEditors:function(){if(!this._columnEditors&&!this._commonEditors)return;var t=this._getAllCellEditors();e.Array.each(t,function(e){e&&e.destroy&&e.destroy()}),this._commonEditors=null,this._columnEditors=null,e.Array.each(this.get("columns"),function(e){(e.editable===undefined||e.editable===!0)&&this._updateEditableColumnCSS(e.key||e.name,!1)},this)},_getAllCellEditors:function(){var t=[];return this._commonEditors&&e.Object.each(this._commonEditors,function(n){n&&n instanceof e.View&&t.push(n)}),this._columnEditors&&e.Object.each(this._columnEditors,function(n){n&&n instanceof e.View&&t.push(n)}),t},_onKeyEsc:function(e){e.keyCode===27&&this.hideCellEditor()},_afterEditableSort:function(){this.get("editable")&&(this.hideCellEditor(),this._updateAllEditableColumnsCSS())},_unsetEditor:function(){this._openEditor=null,this._openRecord=null,this._openColKey=null,this._openCell=null,this._openTd=null},_updateAllEditableColumnsCSS:function(){if(this.get("editable")){var t=this.get("columns"),n;e.Array.each(t,function(e){n=e.key||e.name,n&&this._updateEditableColumnCSS(n,!0)},this)}},_updateEditableColumnCSS:function(e,t){var n=this.get("contentBox").one("tbody."+this.getClassName("data")),r=e?this.getColumn(e):null,i=r&&r.editable!==!1,s;if(!e||!r||!i)return;i=r.editor||this.get("defaultEditor")!==null&&this.get("defaultEditor").search(/none/i)!==0?!0:!1;if(!n||!i)return;s=n.all("td."+this.getClassName("col",e)),s&&t===!0?s.addClass(this._classColEditable):s&&s.removeClass(this._classColEditable)},_handleCellClick:function(e){var t=e.currentTarget,n=this.getColumnNameByTd(t);n&&this._openEditor&&this._openEditor.get("colKey")!==n&&this.hideCellEditor()},_onScrollUpdateCellEditor:function(e){if(this.get("editable")&&this.get("scrollable")&&this._openEditor&&this._openTd){var t=e.target,n=t.get("className")||"",r=this.getRow(0),i=r?+r.getComputedStyle("height").replace(/px/,""):0,s=this._openTd?this._openTd.getXY():null,o,u,a,f,l;n.search(/-y-/)!==-1&&(a=this._yScrollNode.getY()+i-5,f=a+ +this._yScrollNode.getComputedStyle("height").replace(/px/,"")-2*i,s[1]>=a&&s[1]<=f?this._openEditor.get("hidden")?this._openEditor.showEditor(this._openTd):this._openEditor.set("xy",s):l=!0),n.search(/-x-/)!==-1&&(o=this._xScrollNode.getX(),u=o+ +this._xScrollNode.getComputedStyle("width").replace(/px/,""),u-=+this._openTd.getComputedStyle("width").replace(/px/,""),s[0]>=o&&s[0]<=u?this._openEditor.get("hidden")?this._openEditor.showEditor(this._openTd):this._openEditor.set("xy",s):l=!0),l&&this._openEditor.hideEditor(!0)}},_onKeyDirChange:function(t){var n=t.newVal,r=this.data.indexOf(this._openRecord),i=this.getColumn(this._openColKey),s=e.Array.indexOf(this.get("columns"),i),o=this._openTd,u,a,f;this.hideCellEditor(),f&&(n[1]===1&&s===this.get("columns").length-1?a=[0,-this.get("columns").length+1]:n[1]===-1&&s===0?a=[0,this.get("columns").length-1]:n[0]===1&&r===this.data.size()-1?a=[-this.data.size()+1,0]:n[0]===-1&&r===0&&(a=[this.data.size()-1,0]),a&&(n=a)),n&&(u=this.getCell(o,n),u&&this.openCellEditor(u))},_onCellEditorCancel:function(e){if(e.cell&&this._openRecord&&this._openColKey){var t=e.cell,n=t.colKey||this._openColKey,r=this.data.getByClientId(t.recClientId)||this._openRecord,i=this._openEditor.get("name");this._openEditor.get("hidden")||this.hideCellEditor(),this.fire("cellEditorCancel",{td:e.td,cell:t,record:r,colKey:n,prevVal:e.oldValue,editorName:i})}},_onCellEditorSave:function(e){if(e.cell&&this._openRecord&&this._openColKey){var t=e.cell,n=t.colKey||this._openColKey,r=this.data.getByClientId(t.recClientId)||this._openRecord,i=this._openEditor.get("name");r&&r.set(this._openColKey,e.newValue),this.hideCellEditor(),this.fire("cellEditorSave",{td:e.td,cell:t,record:r,colKey:n,newVal:e.newValue,prevVal:e.oldValue,editorName:i})}}}),e.DataTable.Editable=DtEditable,e.Base.mix(e.DataTable,[e.DataTable.Editable]),e.DataTable.EditorOptions={}},"gallery-2013.01.16-21-05",{supersedes:[""],skinnable:"true",requires:["datatable-base","datatype"],optional:[""]});
