YUI.add("gallery-datatable-row-expansion",function(e,t){"use strict";function n(e){n.superclass.constructor.call(this,e)}function r(t){var r=this.rowexpander,i="";for(var s=0;s<=r.col_count.pre;s++)i+='<td class="yui3-datatable-cell pre-row-expansion">&nbsp;</td>';var o=r.get("template");if(e.Lang.isFunction(o))var u=o.call(this,t.data);else var u=e.Lang.sub(o,t.data);var a=t.cell.ancestor(),f=e.Lang.sub('<tr class="{c}">{pre}<td colspan="{post}" class="yui3-datatable-cell post-row-expansion">{tmpl}</td></tr>',{c:a.get("className")+" "+n.row_class,pre:i,post:r.col_count.post,tmpl:u});a.insert(f,"after")}function i(e){var t=this.rowexpander,n=e.data[t.get("uniqueIdKey")],i=t.open_rows[n];e.td.addClass("row-toggle"),e.td.replaceClass("row-(open|closed)",i?"row-open":"row-closed"),e.td.on("click",function(){var i=t.open_rows[n]=!t.open_rows[n];e.td.replaceClass("row-(open|closed)",i?"row-open":"row-closed"),i?r.call(this,e):e.cell.ancestor().next().remove()},this),e.cell.set("innerHTML",'<a class="row-expand-nub" href="javascript:void(0);"></a>'),i&&r.call(this,e)}function s(){function t(r,s){return s.key==n.column_key?(s.nodeFormatter=i,r.found=!0):s.children?r=e.reduce(s.children,r,t):r[r.found?"post":"pre"]++,r}this.col_count=e.reduce(this.get("host").get("columns"),{pre:0,post:0,found:!1},t)}function u(t,r){var i=this.tbodyNode,s,u;if(t&&i){if(e.Lang.isString(r)){if(!o[r])throw Error("unknown shift in getCell: "+r);r=o[r]}if(e.Lang.isArray(t))s=i.get("children").item(0),u=s&&s.get("children").item(t[1]),r?r[0]+=t[0]:r=[t[0],0];else if(t._node){u=t.ancestor("."+this.getClassName("cell"),!0);if(u.ancestor("tr."+n.row_class))throw Error("getCell cannot be called with an element from an expansion row")}if(u&&r){var a=i.get("firstChild.rowIndex");if(e.Lang.isArray(r)){s=u.ancestor();var f=Math.sign(r[0]);if(f!==0){var l=i.get("children"),c=s.get("rowIndex")-a,h=Math.abs(r[0]);for(var p=0;p<h&&s;p++)c+=f,s=l.item(c),s&&s.hasClass(n.row_class)&&(c+=f,s=l.item(c))}c=u.get("cellIndex")+r[1],u=s&&s.get("children").item(c)}}}return u||null}function a(t){var n=this.tbodyNode,r=null;return n&&(t&&(t=this._idMap[t.get?t.get("clientId"):t]||t),r=e.one(e.Lang.isNumber(t)?this.getCell([t,0]).ancestor():"#"+t)),r}function f(){var t=this.get("host").view;if(t instanceof e.DataTable.TableView&&t.body instanceof e.DataTable.BodyView){var n=t.body;this.orig_getCell=n.getCell,this.orig_getRow=n.getRow,n.getCell=u,n.getRow=a}}function l(){var e=this.get("host").view;e.body&&this.orig_getCell&&(e.body.getCell=this.orig_getCell),e.body&&this.orig_getRow&&(e.body.getRow=this.orig_getRow)}n.NAME="DataTableRowExpansionPlugin",n.NS="rowexpander",n.ATTRS={template:{value:"",validator:function(t){return e.Lang.isString(t)||e.Lang.isFunction(t)}},uniqueIdKey:{value:"",validator:e.Lang.isString}},n.column_key="row-expander",n.row_class="row-expansion";var o={above:[-1,0],below:[1,0],next:[0,1],prev:[0,-1],previous:[0,-1]};e.extend(n,e.Plugin.Base,{initializer:function(e){this.open_rows={},this.on("uniqueIdKeyChange",function(){this.open_rows={}}),s.call(this),this.afterHostEvent("columnsChange",s),this.afterHostEvent("table:renderTable",f)},destructor:function(){l.call(this)}}),e.namespace("Plugin"),e.Plugin.DataTableRowExpansion=n},"gallery-2014.03.06-14-38",{skinnable:"true",requires:["datatable","plugin","gallery-funcprog","gallery-node-optimizations","gallery-math"]});
