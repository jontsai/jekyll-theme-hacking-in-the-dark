YUI.add("gallery-datetime",function(e,t){"use strict";function s(e){s.superclass.constructor.apply(this,arguments)}function o(t){return e.one(t)||Attribute.INVALID_VALUE}function u(t){return t?e.DateTimeUtils.normalize(t,this.get("blankTime")):null}function a(){this.ignore_value_set||f.call(this,"same-day")}function f(t){var n=this.getDateTime();if(!n&&this.get("allowBlank")){var r=this.get("dateInput").get("value").length;if(r===0){this.ignore_value_set=!0,this.get("timeInput").set("value",""),this.ignore_value_set=!1,this.prev_date_time=null;return}if(r>0&&this.get("timeInput").get("value").length===0){this.get("timeInput").set("value",e.DateTimeUtils.formatTime(this.get("blankTime")));return}}if(!n&&this.prev_date_time)n=e.clone(this.prev_date_time),this.ignore_value_set=!0,this.get("dateInput").set("value",e.DateTimeUtils.formatDate(n)),this.get("timeInput").set("value",e.DateTimeUtils.formatTime(n)),this.ignore_value_set=!1;else if(!n)return;n=n.date;var i=new Date(n.getTime()),s=this.get("blackouts");if(s.length>0){var o=n.getTime(),a=o,f=t=="same-day"?0:this.get("blackoutSnapDirection");for(var c=0;c<s.length;c++){var h=s[c];if(h[0]<o&&o<h[1]){f>0?o=h[1]+6e4:f<0?o=h[0]:o-h[0]<h[1]-o?o=h[0]:o=h[1]+6e4;break}}o!=a&&(n=new Date(o))}var p=this.get("minDateTime");if(p){var o=p.date.getTime();if(s.length>0){var a=o,c=0;while(c<s.length&&s[c][0]<o)o=Math.max(a,s[c][1]),c++}n.getTime()<o&&(n=new Date(o))}var d=this.get("maxDateTime");if(d){var o=d.date.getTime();if(s.length>0){var a=o,c=s.length-1;while(c>=0&&o<s[c][1])o=Math.min(a,s[c][0]),c--}o<n.getTime()&&(n=new Date(o))}if(n.getFullYear()!==i.getFullYear()||n.getMonth()!==i.getMonth()||n.getDate()!==i.getDate()){var v=l.call(this);v.dateInput=e.DateTimeUtils.formatDate(n),v.timeInput=e.DateTimeUtils.formatTime(n)}else if(n.getHours()!==i.getHours()||n.getMinutes()!==i.getMinutes()){var v=l.call(this);v.timeInput=e.DateTimeUtils.formatTime(n)}else this.fire("limitsEnforced");this.prev_date_time=u.call(this,n)}function l(){return this.enforce_timer||(this.enforce_timer=e.later(0,this,c)),this.enforce_timer}function c(){var t=this.enforce_timer;this.enforce_timer=null;var n=[];this.ignore_value_set=!0,e.each(["dateInput","timeInput"],function(e){t[e]&&(this.get(e).set("value",t[e]),n.push(e))},this),this.ignore_value_set=!1,d.apply(this,n),this.fire("limitsEnforced")}function h(){function t(){var t=u;e.each(arguments,function(e){t[e]||(t[e]={}),t=t[e]})}function i(e,n){var r=e.getFullYear(),i=e.getMonth(),s=e.getDate();t(r,i,s),u[r][i][s]=n}function s(e,t){var n=new Date(e);n.setDate(n.getDate()+t);while(n.getMonth()==e.getMonth())i(n,"disabled"),n.setDate(n.getDate()+t)}if(!this.calendar)return;var o=this.get("blackouts").slice(0),u={},a=this.get("minDateTime");if(a){if(o.length>0){var f=a.date.getTime(),l=!1;for(var c=0;c<o.length;c++){var h=o[c];if(h[1]<=f)o.shift(),c--;else if(h[0]<f){var d=new Date(h[0]);d.setHours(0),d.setMinutes(0),d.setSeconds(n),o[c]=[d.getTime(),h[1]],l=!0;break}}}!l&&(a.hour>0||a.minute>0)&&i(a.date,"partial"),s(a.date,-1)}var v=this.get("maxDateTime");if(v){if(o.length>0){var f=v.date.getTime(),l=!1;for(var c=o.length-1;c>=0;c--){var h=o[c];if(f<=h[0])o.pop();else if(f<h[1]){var m=new Date(h[1]);m.setHours(23),m.setMinutes(59),m.setSeconds(r),o[c]=[h[0],m.getTime()],l=!0;break}}}!l&&(v.hour<23||v.minute<59)&&i(v.date,"partial"),s(v.date,1)}for(var c=0;c<o.length;c++){var h=o[c],d=new Date(h[0]+r*1e3),m=new Date(h[1]+n*1e3);if(d.getHours()>0||d.getMinutes()>0)i(d,"partial"),d.setDate(d.getDate()+1),d.setHours(0);if(m.getHours()<23||m.getMinutes()<59)i(m,"partial"),m.setDate(m.getDate()-1),m.setHours(23);while(d.getTime()<m.getTime())i(d,"disabled"),d.setDate(d.getDate()+1)}this.calendar.set("customRenderer",{rules:u,filterFunction:p})}function p(t,n,r){e.Array.indexOf(r,"partial")>=0?n.addClass("yui3-datetime-partial"):e.Array.indexOf(r,"disabled")>=0&&n.addClass("yui3-calendar-selection-disabled")}function d(){var t=this.get("pingDuration");if(t<=0)return;var n=new e.NodeList(e.reduce(arguments,[],function(e,t){return e.push(this.get(t)),e},this)),r=this.get("pingClass");this.ping_task&&(this.ping_task.nodes.removeClass(r),this.ping_task.cancel(),n=n.concat(this.ping_task.nodes)),n.addClass(r),this.ping_task=e.later(t,this,function(){this.ping_task=null,n.removeClass(r)}),this.ping_task.nodes=n}var n=-40,r=40,i=0<e.UA.ie;s.NAME="datetime",s.ATTRS={dateInput:{setter:o,writeOnce:!0},timeInput:{setter:o,writeOnce:!0},allowBlank:{value:!0,validator:e.Lang.isBoolean},defaultDateTime:{setter:u},minDateTime:{setter:u},maxDateTime:{setter:u},blankTime:{value:{hour:0,minute:0},validator:function(t){return e.Lang.isObject(t)&&e.Lang.isNumber(t.hour)&&e.Lang.isNumber(t.minute)}},blackouts:{value:[],validator:e.Lang.isArray,setter:function(t){t=t||[];var i=[],s=this.get("blankTime");for(var o=0;o<t.length;o++){var u=t[o];u.start=e.DateTimeUtils.normalize(u.start,s),u.end=e.DateTimeUtils.normalize(u.end,s),u=[(new Date(u.start.year,u.start.month-1,u.start.day,u.start.hour,u.start.minute,n)).getTime(),(new Date(u.end.year,u.end.month-1,u.end.day,u.end.hour,u.end.minute,r)).getTime()];var a=!1;for(var f=0;f<i.length;f++){var l=i[f];if(u[0]<=l[0]){f>0&&u[0]<i[f-1][1]&&u[1]<=i[f-1][1]||(f>0&&u[0]-6e4<i[f-1][1]&&l[0]<u[1]+6e4?(u=[i[f-1][0],u[1]],i.splice(f-1,2,u)):f>0&&u[0]-6e4<i[f-1][1]?i[f-1][1]=u[1]:l[0]<u[1]+6e4?l[0]=u[0]:i.splice(f,0,u)),a=!0;break}}!a&&f>0&&u[0]<i[f-1][1]&&u[1]<=i[f-1][1]||(!a&&f>0&&u[0]-6e4<i[f-1][1]?i[f-1][1]=u[1]:a||i.push(u))}return i}},blackoutSnapDirection:{value:0,validator:function(e){return e==-1||e===0||e==+1}},pingDuration:{value:2e3,validator:e.Lang.isNumber},pingClass:{value:"yui3-datetime-ping",validator:e.Lang.isString}},e.extend(s,e.Base,{initializer:function(t,n){function l(e,t){t.newVal?(f.call(this),this.calendar&&this.calendar.set(e,t.newVal.date)):this.calendar&&this.calendar.set(e,null),h.call(this)}var r=this.get("dateInput"),i=this.get("timeInput");if(!i){i=e.Node.create('<input type="hidden"></input>'
),this.set("timeInput",i),i.set("value",e.DateTimeUtils.formatTime(this.get("blankTime")));var s=!0}var o=this.get("defaultDateTime");o&&(r.set("value",e.DateTimeUtils.formatDate(o)),s||i.set("value",e.DateTimeUtils.formatTime(o)),this.prev_date_time=o);if(r.calendarSync){this.calendar=r.calendarSync.get("calendar"),this.calendar&&o&&this.calendar.set("date",o.date);var u=this.get("minDateTime");this.calendar&&u&&this.calendar.set("minimumDate",u.date),u=this.get("maxDateTime"),this.calendar&&u&&this.calendar.set("maximumDate",u.date),this.set("allowBlank",r.calendarSync.get("allowBlank"))}r.on("change",f,this),r.after("valueSet",a,this),i.on("change",f,this),i.after("valueSet",a,this),f.call(this),this.after("minDateTimeChange",e.bind(l,this,"minimumDate")),this.after("maxDateTimeChange",e.bind(l,this,"maximumDate")),this.after("blackoutsChange",function(){f.call(this),h.call(this)}),h.call(this)},getDateTime:function(){try{var t=e.DateTimeUtils.parseDate(this.get("dateInput").get("value"));if(!t)return!1}catch(n){return!1}try{var r=e.DateTimeUtils.parseTime(this.get("timeInput").get("value"));if(!r)return!1}catch(n){return!1}var i=e.DateTimeUtils.normalize(e.mix(t,r));return i.date_str=e.DateTimeUtils.formatDate(i),i.time_str=e.DateTimeUtils.formatTime(i),i},setDateTime:function(t){t=u.call(this,t),t&&(this.ignore_value_set=!0,this.get("dateInput").set("value",e.DateTimeUtils.formatDate(t)),this.get("timeInput").set("value",e.DateTimeUtils.formatTime(t)),this.ignore_value_set=!1,f.call(this))},resetDateTime:function(){var e=this.get("defaultDateTime");if(e)this.setDateTime(e);else{if(!this.get("allowBlank"))return;this.clearDateTime()}f.call(this)},clearDateTime:function(){this.get("allowBlank")?this.get("dateInput").set("value",""):this.resetDateTime()}}),e.DateTime=s},"gallery-2014.02.13-03-13",{skinnable:"true",requires:["base","gallery-datetime-utils","gallery-funcprog"],optional:["calendar","gallery-timepicker"]});
